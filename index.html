<!DOCTYPE html>
<head>
    <meta charset="utf-8" />
    <title>IPFS Image Uploader</title>
    <link rel="stylesheet" type="text/css" href="main.css">
	<link href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.19/css/jquery.dataTables.css">
	<style>
		input[type="file"] {
    		display: none;
		}
	</style>
	<script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js/dist/web3.js"></script>
	<script src="https://unpkg.com/ipfs-api/dist/index.js"></script>
</head>
<body>
    <div class="container">

        <h1>IPFS Image Uploader</h1>

    	<div class="panel panel-default">
        	<div class="panel-heading">New Image File</div>
        	<div class="panel-body">       
            	<div class="form-group">
                	<label for="file-upload" class="btn btn-primary">
    					<i class="fa fa-cloud-upload"></i> Select Image
					</label>
                	<input id="file-upload" type="file"/>
                	<img id="loader" src="https://loading.io/spinners/reload/index.ajax-syncing-loading-icon.svg">
            	</div>
        	</div>
    	</div>

        <div class="panel panel-default">
        	<div class="panel-heading">Details</div>
        	<div class="panel-body"> 
        		<div id="ipfshash"></div>
        		<div id="tx"></div>
            	<div id="imgdiv"></div>
        	</div>
    	</div>    
    
    </div>
    
    <script>
        
        $(document).ready( function () {
		} );
    
       if (typeof web3 !== 'undefined') {
            web3 = new Web3(web3.currentProvider);
        } else {
            // set the provider you want from Web3.providers
            web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
        }
    	ipfs = new window.IpfsApi('ipfs.infura.io', '5001', { protocol: 'https' });
    	ipfs.id(function(err, res) {
 			if (err) throw err
 				console.log("Connected to IPFS node!", res.id, res.agentVersion, res.protocolVersion);
 		});
		web3.eth.defaultAccount = web3.eth.accounts[0];
		var Buffer = window.IpfsApi().Buffer;
    	var ImageContract = web3.eth.contract(
			[
				{
					"anonymous": false,
					"inputs": [],
					"name": "savedHash",
					"type": "event"
				},
				{
					"constant": false,
					"inputs": [
						{
							"name": "x",
							"type": "string"
						}
					],
					"name": "setHash",
					"outputs": [],
					"payable": false,
					"stateMutability": "nonpayable",
					"type": "function"
				},
				{
					"constant": true,
					"inputs": [],
					"name": "getHash",
					"outputs": [
						{
							"name": "x",
							"type": "string"
						}
					],
					"payable": false,
					"stateMutability": "view",
					"type": "function"
				}
			]
        );
    
        var ImageContractCall = ImageContract.at('0xf216028e096c969ec85302651de4584a606e9903');
        console.log(ImageContractCall);
    
    	var ipfsHash;
    
        $("#file-upload").change(function() {
            //source:https://stackoverflow.com/questions/29805909/jquery-how-to-check-if-uploaded-file-is-an-image-without-checking-extensions
            var file = this.files[0];
            var fileType = file["type"];
            var ValidImageTypes = ["image/gif", "image/jpeg", "image/png"];
            if ($.inArray(fileType, ValidImageTypes) < 0) {
                window.alert("you didn't choose an image");
            }
            else {
      		$("#loader").show();
            	var reader = new FileReader();
      			reader.onload = function() {
                    mybuffer = Buffer.from(this.result);
                	ipfs.files.add(mybuffer, function(err, result){
                    	if (err) {
        					console.log("Error");
      					} 
                    	else {
                        	ipfsHash = result[0].hash;
                        	ImageContractCall.setHash(ipfsHash, {gas: 1000000, gasPrice: web3.toWei(2, 'gwei')}, function(error, result){
       							if(!error){
                                	$("#tx").html("ETH Tx: " + JSON.stringify(result));
                    			}
       							else{
           							console.error(error);
                    			}
                            });
      					}
                    });
    			}
    			reader.readAsArrayBuffer(this.files[0]);  	
            }
        });
    	var savedHash = ImageContractCall.savedHash();
    	savedHash.watch(function(error, result){
            if (!error)
                {
                	ipfs.pin.add(ipfsHash, function (err) {
                    	if (err){
							console.log("cannot pin");
                        }
                    	else{
                        	console.log("pin ok");
                        }
                    });
                    $("#loader").hide();
                    $("#ipfshash").html("IPFS Hash: " + ipfsHash);
                    $("#imgdiv").html("<img src=https://gateway.ipfs.io/ipfs/" + ipfsHash + " width='400'>");
                } else {
                    $("#loader").hide();
                }
        });
        
    </script>
    
</body>
</html>
